# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Dungeons and Datums is an Astro-based static blog site exploring the intersection of tabletop role-playing games and data science. The site uses Astro's content collections for type-safe blog post management, Tailwind CSS with DaisyUI for styling, and includes features like search, pagination, RSS feeds, and related posts.

## Development Commands

```bash
# Start development server (http://localhost:4321)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview

# Lint code
npm run lint

# Fix linting issues
npm run lint:fix

# Format code
npm run format

# Check formatting
npm run format:check

# Content creation and management
npm run new-post                    # Interactive CLI to create new blog posts
npm run generate-description [slug] # Generate SEO description using AI (optional slug)
npm run generate-preview [slug]     # Generate preview excerpt using AI (optional slug)
npm run generate-posts [count]      # Generate example posts for development (default: 20)
npm run cleanup-posts               # Remove all example-*.md posts
```

## Architecture

### Content Management

- **Content Collections**: Blog posts are managed via Astro's content collections system in `src/content/blog/`
- **Schema Validation**: All blog posts must conform to the Zod schema defined in `src/content/config.ts`
- **Required Frontmatter**: `title`, `description`, `pubDate`, `category`, `tags`, `draft`
- **Optional Frontmatter**: `preview`, `heroImage`, `heroImageAlt`, `updatedDate`
- **Field Distinction**: `description` is a short SEO meta description (1-2 sentences); `preview` is a longer excerpt (1 paragraph) shown on listing pages
- **Draft Support**: Posts with `draft: true` are filtered out by `getPublishedPosts()` in `src/utils/blog.ts`

### Utility Functions (`src/utils/blog.ts`)

Core blog functionality is centralized in utility functions:
- `getAllPosts()`: Fetches all posts sorted by date (newest first)
- `getPublishedPosts()`: Filters out drafts
- `getPostsByCategory()` / `getPostsByTag()`: Filter by taxonomy
- `getRelatedPosts()`: Calculates related posts using scoring (category match = 3 points, each common tag = 1 point)
- `calculateReadingTime()`: Estimates reading time at 200 words per minute
- `paginatePosts()`: Splits posts into pages

### Search Implementation

- **Client-side Search**: Uses Fuse.js for fuzzy search
- **Search Weights**: Title (3x), Description (2x), Tags (1.5x), Category (1x), Content (0.5x)
- **Threshold**: 0.4 for fuzzy matching
- **Implementation**: `src/utils/search.ts` provides `createSearchIndex()` and `searchPosts()`

### Routing Structure

- `/` - Home page with paginated posts
- `/page/[page]` - Pagination pages
- `/blog/[...slug]` - Individual blog posts (catch-all route)
- `/blog/category/[category]` - Posts filtered by category
- `/blog/tag/[tag]` - Posts filtered by tag
- `/rss.xml` - RSS feed generated by `src/pages/rss.xml.ts`

### Styling & Theming

- **CSS Framework**: Tailwind CSS 4.x with Vite plugin
- **Component Library**: DaisyUI 5.x
- **Custom Themes**: Uses custom `topo-dark` and `topo-light` themes
- **Theme Persistence**: Theme preference stored in localStorage with system preference fallback
- **Theme Prevention**: Inline script in BaseLayout.astro prevents flash of wrong theme
- **Global Styles**: `src/styles/global.css` contains custom theme definitions and global styles

### Components

Blog-specific components in `src/components/blog/`:
- `BlogCard.astro` - Post preview card
- `Pagination.astro` - Page navigation
- `RelatedPosts.astro` - Similar posts section
- `ReadingTime.astro` - Reading time display
- `TagList.astro` - Tag display and links
- `SearchBar.astro` - Search interface

### SEO & Metadata

- **Site URL**: Configured in `astro.config.mjs` as `https://dungeonsanddatums.com`
- **Open Graph Tags**: Implemented in BaseLayout.astro
- **Canonical URLs**: Auto-generated for all pages
- **RSS Feed**: Auto-generated at `/rss.xml` using `@astrojs/rss`
- **Sitemap**: Auto-generated using `@astrojs/sitemap` integration

## Code Conventions

### TypeScript

- **Strict Mode**: Uses `astro/tsconfigs/strict`
- **Type Safety**: BlogPost type defined as `CollectionEntry<'blog'>` in `src/utils/blog.ts`
- **Zod Schemas**: Content validation via Zod in `src/content/config.ts`

### Linting & Formatting

- **ESLint**: Flat config format with TypeScript and Astro plugins
- **Prettier**: Configured with Astro plugin
- **Unused Vars**: Allowed when prefixed with `_`

### Component Structure

- Components use `.astro` extension
- Blog-specific components are grouped in `src/components/blog/`
- Layout components in `src/layouts/`
- Reusable utilities in `src/utils/`

## Creating Blog Posts

1. Create a new `.md` file in `src/content/blog/`
2. Add required frontmatter (see schema in `src/content/config.ts`)
3. Set `draft: false` to publish or `draft: true` to hide
4. Images should be placed in `public/` directory
5. Use standard markdown syntax for content

## Important Notes

- Pagination is set to 10 posts per page in `src/pages/index.astro` and `src/pages/page/[page].astro`
- Related posts algorithm prioritizes same category (3 points) and shared tags (1 point each)
- Search index is created at build time and uses client-side fuzzy matching
- Theme switching requires updating the `data-theme` attribute and localStorage
- All dates are coerced to Date objects via Zod schema
